generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for type safety
enum LeadStatus {
  NEW
  QUALIFIED
  DECLINED
  ESTIMATED
}

enum EstimateStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
}

enum Confidence {
  LOW
  MEDIUM
  HIGH
}

enum TradeType {
  ROOFING
  PAINTING
  FLOORING
  SIDING
  BATH
  KITCHEN
  DECK
  FENCE
  ADDITION
  OTHER
}

enum UserRole {
  OWNER
  ESTIMATOR
  PM
  ADMIN
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentType {
  DEPOSIT
  FINAL
  MILESTONE
}

enum ProjectOutcome {
  WON
  LOST
  IN_PROGRESS
  CANCELLED
}

enum DocumentType {
  PDF
  IMAGE
  DWG
  OTHER
}

enum TakeoffSourceType {
  PHOTO
  DOCUMENT
  HYBRID
}

// Models
model Contractor {
  id                String           @id @default(cuid())
  slug              String           @unique
  companyName       String
  email             String           @unique
  phone             String?
  trades            TradeType[]
  depositPercentage Decimal          @default(25) @db.Decimal(5, 2)
  leads             Lead[]
  estimates         Estimate[]
  users             ContractorUser[]
  aiUsages          AIUsage[]
  createdAt         DateTime         @default(now())
}

model ContractorUser {
  id           String     @id @default(cuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  email        String     @unique
  role         UserRole   @default(PM)
  createdAt    DateTime   @default(now())

  @@index([contractorId])
}

model Lead {
  id               String     @id @default(cuid())
  contractorId     String
  contractor       Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  homeownerName    String
  homeownerEmail   String
  homeownerPhone   String
  address          String
  tradeType        TradeType
  budgetCents      Int?
  timeline         String?
  stripeCustomerId String?
  photos           Photo[]
  documents        Document[]
  takeoffs         Takeoff[]
  estimates        Estimate[]
  aiUsages         AIUsage[]
  status           LeadStatus @default(NEW)
  score            Float?
  notes            String?    @db.Text
  createdAt        DateTime   @default(now())

  @@index([contractorId, createdAt])
  @@index([status, score])
  @@index([tradeType])
  @@index([contractorId, status, createdAt])
}

model Photo {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  url       String
  key       String   @unique
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([leadId])
}

model Document {
  id            String       @id @default(cuid())
  leadId        String
  lead          Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  url           String
  key           String       @unique
  fileName      String
  fileType      DocumentType
  fileSizeBytes Int
  metadata      Json? // Store extracted data, page count, dimensions, etc.
  createdAt     DateTime     @default(now())

  @@index([leadId])
  @@index([fileType])
}

model Takeoff {
  id               String             @id @default(cuid())
  leadId           String
  lead             Lead               @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tradeType        TradeType
  provider         String
  version          String
  sourceType       TakeoffSourceType  @default(PHOTO) // Track what was analyzed
  documentIds      String[] // IDs of documents used in this takeoff
  data             Json
  confidence       Float?
  // AI analysis accuracy review fields
  reviewedAt       DateTime?
  accuracyFeedback Json? // Array of { field: string, correct: boolean, correctedValue?: any }
  overallAccuracy  Float? // 0-1 score based on feedback
  reviewNotes      String?            @db.Text
  createdAt        DateTime           @default(now())

  @@index([leadId, createdAt])
  @@index([reviewedAt])
  @@index([sourceType])
}

model Estimate {
  id              String          @id @default(cuid())
  leadId          String
  contractorId    String
  lead            Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contractor      Contractor      @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  lineItems       Json
  subtotal        Decimal         @db.Decimal(18, 2)
  margin          Decimal         @db.Decimal(5, 2)
  contingency     Decimal         @db.Decimal(5, 2)
  total           Decimal         @db.Decimal(18, 2)
  confidence      Confidence
  status          EstimateStatus  @default(DRAFT)
  proposalUrl     String?
  publicToken     String?         @unique @default(cuid())
  expiresAt       DateTime?
  // Project outcome feedback fields
  projectOutcome  ProjectOutcome?
  actualCost      Decimal?        @db.Decimal(18, 2)
  completedAt     DateTime?
  feedbackNotes   String?         @db.Text
  variance        Decimal?        @db.Decimal(18, 2) // actualCost - total
  variancePercent Decimal?        @db.Decimal(8, 2) // (variance / total) * 100 - FIXED: supports large variances
  payments        Payment[]
  aiUsages        AIUsage[]
  createdAt       DateTime        @default(now())

  @@index([contractorId, createdAt])
  @@index([leadId])
  @@index([publicToken])
  @@index([projectOutcome, completedAt])
  @@index([status])
  @@index([contractorId, status])
}

model Template {
  id        String    @id @default(cuid())
  tradeType TradeType
  name      String
  lineItems Json
  createdAt DateTime  @default(now())

  @@index([tradeType])
}

model SupplierPrice {
  id           String   @id @default(cuid())
  contractorId String
  materialSKU  String
  description  String
  unitCost     Decimal  @db.Decimal(18, 4)
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@index([contractorId, updatedAt])
  @@index([materialSKU])
}

model Payment {
  id               String        @id @default(cuid())
  estimateId       String
  estimate         Estimate      @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  stripePaymentId  String?       @unique
  stripeCheckoutId String?       @unique
  amount           Decimal       @db.Decimal(18, 2)
  type             PaymentType
  status           PaymentStatus @default(PENDING)
  paidAt           DateTime?
  metadata         Json?
  createdAt        DateTime      @default(now())

  @@index([estimateId])
  @@index([status])
}

model AIUsage {
  id            String     @id @default(cuid())
  contractorId  String
  contractor    Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  leadId        String?
  lead          Lead?      @relation(fields: [leadId], references: [id], onDelete: SetNull)
  estimateId    String?
  estimate      Estimate?  @relation(fields: [estimateId], references: [id], onDelete: SetNull)
  operation     String // e.g., "photo_analysis", "scope_generation", "estimate_generation"
  model         String // e.g., "claude-3-5-sonnet-20241022"
  inputTokens   Int
  outputTokens  Int
  totalTokens   Int
  estimatedCost Decimal    @db.Decimal(10, 6) // Cost in USD
  metadata      Json? // Store additional context (photo count, etc.)
  createdAt     DateTime   @default(now())

  @@index([contractorId, createdAt])
  @@index([leadId])
  @@index([estimateId])
  @@index([operation, createdAt])
}
