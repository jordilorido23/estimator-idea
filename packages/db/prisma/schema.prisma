generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for type safety
enum LeadStatus {
  NEW
  QUALIFIED
  DECLINED
  ESTIMATED
}

enum EstimateStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
}

enum Confidence {
  LOW
  MEDIUM
  HIGH
}

enum TradeType {
  ROOFING
  PAINTING
  FLOORING
  SIDING
  BATH
  KITCHEN
  DECK
  FENCE
  ADDITION
  OTHER
}

enum UserRole {
  OWNER
  ESTIMATOR
  PM
  ADMIN
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentType {
  DEPOSIT
  FINAL
  MILESTONE
}

// Models
model Contractor {
  id                String           @id @default(cuid())
  slug              String           @unique
  companyName       String
  email             String           @unique
  phone             String?
  trades            TradeType[]
  depositPercentage Decimal          @default(25) @db.Decimal(5, 2)
  leads             Lead[]
  estimates         Estimate[]
  users             ContractorUser[]
  createdAt         DateTime         @default(now())
}

model ContractorUser {
  id           String     @id @default(cuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  email        String     @unique
  role         UserRole   @default(PM)
  createdAt    DateTime   @default(now())

  @@index([contractorId])
}

model Lead {
  id               String     @id @default(cuid())
  contractorId     String
  contractor       Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  homeownerName    String
  homeownerEmail   String
  homeownerPhone   String
  address          String
  tradeType        TradeType
  budgetCents      Int?
  timeline         String?
  stripeCustomerId String?
  photos           Photo[]
  takeoffs         Takeoff[]
  estimates        Estimate[]
  status           LeadStatus @default(NEW)
  score            Float?
  notes            String?    @db.Text
  createdAt        DateTime   @default(now())

  @@index([contractorId, createdAt])
  @@index([status, score])
}

model Photo {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  url       String
  key       String   @unique
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([leadId])
}

model Takeoff {
  id         String    @id @default(cuid())
  leadId     String
  lead       Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tradeType  TradeType
  provider   String
  version    String
  data       Json
  confidence Float?
  createdAt  DateTime  @default(now())

  @@index([leadId, createdAt])
}

model Estimate {
  id           String         @id @default(cuid())
  leadId       String
  contractorId String
  lead         Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contractor   Contractor     @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  lineItems    Json
  subtotal     Decimal        @db.Decimal(18, 2)
  margin       Decimal        @db.Decimal(5, 2)
  contingency  Decimal        @db.Decimal(5, 2)
  total        Decimal        @db.Decimal(18, 2)
  confidence   Confidence
  status       EstimateStatus @default(DRAFT)
  proposalUrl  String?
  publicToken  String?        @unique @default(cuid())
  expiresAt    DateTime?
  payments     Payment[]
  createdAt    DateTime       @default(now())

  @@index([contractorId, createdAt])
  @@index([leadId])
  @@index([publicToken])
}

model Template {
  id        String    @id @default(cuid())
  tradeType TradeType
  name      String
  lineItems Json
  createdAt DateTime  @default(now())

  @@index([tradeType])
}

model SupplierPrice {
  id           String   @id @default(cuid())
  contractorId String
  materialSKU  String
  description  String
  unitCost     Decimal  @db.Decimal(18, 4)
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@index([contractorId, updatedAt])
  @@index([materialSKU])
}

model Payment {
  id               String        @id @default(cuid())
  estimateId       String
  estimate         Estimate      @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  stripePaymentId  String?       @unique
  stripeCheckoutId String?       @unique
  amount           Decimal       @db.Decimal(18, 2)
  type             PaymentType
  status           PaymentStatus @default(PENDING)
  paidAt           DateTime?
  metadata         Json?
  createdAt        DateTime      @default(now())

  @@index([estimateId])
  @@index([status])
}
